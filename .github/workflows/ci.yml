name: CI Pipeline

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘  ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆGoï¼‰ãƒ†ã‚¹ãƒˆãƒ»ãƒ“ãƒ«ãƒ‰    â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  backend:
    name: Go Backend Tests & Build
    runs-on: ubuntu-latest
    
    steps:
      # ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # Goç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆ1.21ä»¥ä¸Šæ¨å¥¨ï¼‰
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      # Goä¾å­˜é–¢ä¿‚ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆé€šå¸¸ go.mod/go.sum ã«åŸºã¥ãï¼‰
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # Go ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Run Go tests
        run: go test -v -race -coverprofile=coverage.out ./...
        working-directory: ./

      # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ãƒ¬ãƒãƒ¼ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.out
          flags: go
          name: go-coverage
        continue-on-error: true

      # Go ãƒ“ãƒ«ãƒ‰ç¢ºèªï¼ˆãƒã‚¤ãƒŠãƒªç”Ÿæˆãƒ†ã‚¹ãƒˆï¼‰
      - name: Build Go binary
        run: go build -o ./bin/familydashboard ./cmd/server
        working-directory: ./

      # ãƒ“ãƒ«ãƒ‰æˆåŠŸã‚’ç¢ºèª
      - name: Verify binary
        run: ls -lh ./bin/familydashboard

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘   ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆSvelteï¼‰ãƒ“ãƒ«ãƒ‰    â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  frontend:
    name: Svelte Frontend Build
    runs-on: ubuntu-latest
    
    steps:
      # ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆæœ€æ–°LTSæ¨å¥¨ã€Viteè¦ä»¶ï¼‰
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      # npmä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install frontend dependencies
        run: npm ci
        working-directory: ./frontend

      # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ static ãƒ“ãƒ«ãƒ‰ç”Ÿæˆ
      - name: Build Svelte project
        run: npm run build
        working-directory: ./frontend

      # ãƒ“ãƒ«ãƒ‰ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆç¢ºèª
      - name: Verify build output
        run: |
          if [ -d "./frontend/build" ]; then
            echo "âœ“ Frontend build directory exists"
            ls -la ./frontend/build | head -20
          else
            echo "âœ— Frontend build directory not found!"
            exit 1
          fi

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘     Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ ãƒ“ãƒ«ãƒ‰ç¢ºèª       â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  docker-build:
    name: Docker Build Verification
    runs-on: ubuntu-latest
    
    steps:
      # ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ï¼ˆãƒ—ãƒƒã‚·ãƒ¥ã—ãªã„ï¼‰
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: familydashboard:ci-test

  # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  # â•‘         çµæœã‚µãƒãƒªãƒ¼                  â•‘
  # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend, docker-build]
    if: always()  # å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒå¤±æ•—ã—ã¦ã‚‚ã‚µãƒãƒªãƒ¼ã¯å®Ÿè¡Œ
    
    steps:
      - name: Check CI results
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘      CI Pipeline Results Summary      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Backend Tests:    ${{ needs.backend.result }}"
          echo "Frontend Build:   ${{ needs.frontend.result }}"
          echo "Docker Build:     ${{ needs.docker-build.result }}"
          echo ""
          
          # ã™ã¹ã¦ãŒæˆåŠŸã—ãŸã‹ãƒã‚§ãƒƒã‚¯
          if [[ "${{ needs.backend.result }}" == "success" && \
                "${{ needs.frontend.result }}" == "success" && \
                "${{ needs.docker-build.result }}" == "success" ]]; then
            echo "âœ“ All CI checks passed! ğŸ‰"
            exit 0
          else
            echo "âœ— Some CI checks failed. Please review logs above."
            exit 1
          fi
